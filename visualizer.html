<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic Music Visualizer - Epic Smile</title>
    <link rel="icon" type="image/png" href="assets/718smiley.png">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .visualizer-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, #1a0033, #000);
        }

        .visualizer-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .center-3d {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 400px;
            z-index: 10;
            pointer-events: none;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            display: flex;
            gap: 15px;
            align-items: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 25px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-btn {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .file-input {
            display: none;
        }

        .file-label {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .volume-slider {
            width: 100px;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            outline: none;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 15px;
            height: 15px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border-radius: 50%;
            cursor: pointer;
        }

        .status {
            color: white;
            font-size: 14px;
            font-weight: 500;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            text-decoration: none;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            z-index: 20;
        }
    </style>
</head>
<body>
    <div class="visualizer-container">
        <canvas class="visualizer-canvas" id="visualizerCanvas"></canvas>
        
        <div class="center-3d" id="center3d"></div>
        
        <a href="index.html" class="back-btn">‚Üê Back to Desktop</a>
        
        <div class="title">Epic Music Visualizer</div>
        
        <div class="controls">
            <input type="file" id="audioFile" class="file-input" accept="audio/*">
            <label for="audioFile" class="file-label">üéµ Load Music</label>
            
            <button class="control-btn" id="playBtn">‚ñ∂Ô∏è Play</button>
            <button class="control-btn" id="pauseBtn">‚è∏Ô∏è Pause</button>
            <button class="control-btn" id="stopBtn">‚èπÔ∏è Stop</button>
            
            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50">
            <span class="status" id="status">Ready to visualize!</span>
        </div>
    </div>

    <script>
        // Audio context and analyzer
        let audioContext;
        let analyser;
        let audioSource;
        let audioElement;
        let isPlaying = false;
        let animationId;

        // Canvas and visualizer
        const canvas = document.getElementById('visualizerCanvas');
        const ctx = canvas.getContext('2d');
        
        // 3D scene variables
        let scene, camera, renderer, model;

        // Initialize everything
        function init() {
            setupCanvas();
            init3D();
            setupEventListeners();
            startVisualizer();
        }

        function setupCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }

        function setupEventListeners() {
            document.getElementById('audioFile').addEventListener('change', handleFileSelect);
            document.getElementById('playBtn').addEventListener('click', playAudio);
            document.getElementById('pauseBtn').addEventListener('click', pauseAudio);
            document.getElementById('stopBtn').addEventListener('click', stopAudio);
            document.getElementById('volumeSlider').addEventListener('input', changeVolume);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                loadAudio(url);
                document.getElementById('status').textContent = `Loaded: ${file.name}`;
            }
        }

        function loadAudio(url) {
            if (audioElement) {
                audioElement.pause();
                audioElement = null;
            }

            audioElement = new Audio(url);
            audioElement.crossOrigin = 'anonymous';
            
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.8;
            }

            if (audioSource) {
                audioSource.disconnect();
            }

            audioSource = audioContext.createMediaElementSource(audioElement);
            audioSource.connect(analyser);
            analyser.connect(audioContext.destination);

            audioElement.addEventListener('ended', () => {
                isPlaying = false;
                document.getElementById('status').textContent = 'Music ended';
            });
        }

        function playAudio() {
            if (audioElement && !isPlaying) {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                audioElement.play();
                isPlaying = true;
                document.getElementById('status').textContent = 'Playing...';
            }
        }

        function pauseAudio() {
            if (audioElement && isPlaying) {
                audioElement.pause();
                isPlaying = false;
                document.getElementById('status').textContent = 'Paused';
            }
        }

        function stopAudio() {
            if (audioElement) {
                audioElement.pause();
                audioElement.currentTime = 0;
                isPlaying = false;
                document.getElementById('status').textContent = 'Stopped';
            }
        }

        function changeVolume() {
            if (audioElement) {
                const volume = document.getElementById('volumeSlider').value / 100;
                audioElement.volume = volume;
            }
        }

        // 3D Scene setup
        function init3D() {
            const container = document.getElementById('center3d');
            
            if (typeof THREE === 'undefined') {
                console.error('Three.js not loaded');
                return;
            }

            // Create scene
            scene = new THREE.Scene();
            scene.background = null;

            // Create camera
            camera = new THREE.PerspectiveCamera(75, 400 / 400, 0.1, 1000);
            camera.position.z = 5;

            // Create renderer
            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(400, 400);
            renderer.setClearColor(0x000000, 0);
            container.appendChild(renderer.domElement);

            // Add lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            scene.add(directionalLight);

            // Load 3D model
            load3DModel();
        }

        function load3DModel() {
            if (typeof THREE.OBJLoader !== 'undefined') {
                const textureLoader = new THREE.TextureLoader();
                textureLoader.load(
                    'assets/epic-face/textures/epic_face_-_Copy.png',
                    function(texture) {
                        const loader = new THREE.OBJLoader();
                        loader.load(
                            'assets/epic-face/source/epic.obj',
                            function(object) {
                                model = object;
                                
                                // Apply texture to all meshes
                                model.traverse(function(child) {
                                    if (child.isMesh) {
                                        child.material = new THREE.MeshLambertMaterial({ map: texture });
                                    }
                                });

                                // Center and scale
                                const box = new THREE.Box3().setFromObject(model);
                                const center = box.getCenter(new THREE.Vector3());
                                model.position.sub(center);
                                
                                const size = box.getSize(new THREE.Vector3());
                                const maxDim = Math.max(size.x, size.y, size.z);
                                const scale = 5 / maxDim;
                                model.scale.setScalar(scale);
                                
                                scene.add(model);
                            },
                            undefined,
                            function(error) {
                                console.error('Error loading 3D model:', error);
                                createFallbackModel();
                            }
                        );
                    },
                    undefined,
                    function(error) {
                        console.error('Error loading texture:', error);
                        createFallbackModel();
                    }
                );
            } else {
                createFallbackModel();
            }
        }

        function createFallbackModel() {
            const geometry = new THREE.SphereGeometry(2, 32, 32);
            const material = new THREE.MeshLambertMaterial({ 
                color: 0xff6b6b,
                wireframe: true
            });
            model = new THREE.Mesh(geometry, material);
            scene.add(model);
        }

        function animate3D() {
            if (model) {
                model.rotation.y += 0.02;
                model.rotation.x += 0.01;
            }
            renderer.render(scene, camera);
        }

        // Visualizer functions
        function startVisualizer() {
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                if (analyser && isPlaying) {
                    drawVisualizer();
                } else {
                    drawIdleVisualizer();
                }
                
                animate3D();
                animationId = requestAnimationFrame(animate);
            }
            animate();
        }

        function drawVisualizer() {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            // Create colorful bars
            const barWidth = canvas.width / bufferLength * 2;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                const barHeight = (dataArray[i] / 255) * canvas.height * 0.8;
                
                // Create gradient colors based on frequency
                const hue = (i / bufferLength) * 360;
                const gradient = ctx.createLinearGradient(0, canvas.height, 0, canvas.height - barHeight);
                gradient.addColorStop(0, `hsl(${hue}, 100%, 50%)`);
                gradient.addColorStop(1, `hsl(${hue + 60}, 100%, 80%)`);
                
                ctx.fillStyle = gradient;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                
                x += barWidth + 1;
            }

            // Add pulsing circles
            drawPulsingCircles(dataArray);
            
            // Add particle effects
            drawParticles(dataArray);
        }

        function drawIdleVisualizer() {
            // Create a subtle idle animation
            const time = Date.now() * 0.001;
            
            // Gradient background
            const gradient = ctx.createRadialGradient(
                canvas.width / 2, canvas.height / 2, 0,
                canvas.width / 2, canvas.height / 2, Math.max(canvas.width, canvas.height) / 2
            );
            gradient.addColorStop(0, `hsla(${(time * 50) % 360}, 70%, 20%, 0.3)`);
            gradient.addColorStop(1, 'hsla(0, 0%, 0%, 0.8)');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Floating particles
            for (let i = 0; i < 20; i++) {
                const x = (Math.sin(time + i) * canvas.width / 4) + canvas.width / 2;
                const y = (Math.cos(time * 0.5 + i) * canvas.height / 4) + canvas.height / 2;
                const size = Math.sin(time * 2 + i) * 3 + 2;
                
                ctx.fillStyle = `hsla(${(time * 30 + i * 20) % 360}, 80%, 60%, 0.6)`;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawPulsingCircles(dataArray) {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const time = Date.now() * 0.001;
            
            // Calculate average amplitude
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length;
            const amplitude = (average / 255) * 100;
            
            // Draw concentric circles
            for (let i = 0; i < 5; i++) {
                const radius = 50 + (amplitude * 2) + (i * 30) + Math.sin(time * 2 + i) * 20;
                const alpha = 0.3 - (i * 0.05);
                
                ctx.strokeStyle = `hsla(${(time * 100 + i * 60) % 360}, 100%, 70%, ${alpha})`;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                ctx.stroke();
            }
        }

        function drawParticles(dataArray) {
            const time = Date.now() * 0.001;
            
            for (let i = 0; i < 50; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = (dataArray[i % dataArray.length] / 255) * 5 + 1;
                const hue = (time * 50 + i * 10) % 360;
                
                ctx.fillStyle = `hsla(${hue}, 100%, 60%, 0.7)`;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Initialize when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
